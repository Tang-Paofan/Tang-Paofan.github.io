---
title: è‡ªç­¾åè¯ä¹¦
mathjax: false
abbrlink: 2f141bd
date: 2025-04-29 17:35:28
tags:
categories:
---

## why
1. å·¥ä½œéœ€è¦ğŸ¤Ÿ
2. HTTPS æ¯” HTTP æ›´å®‰å…¨ï¼Œæ–°å¢äº†SSL
3. éœ€è¦è‡ªç­¾åè¯ä¹¦æˆ–CAè¯ä¹¦
4. å±€åŸŸç½‘å¯ä»¥ä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼Œä½†è¯ä¹¦ä¸èƒ½å¤–æ³„ï¼Œå¦åˆ™å¯èƒ½é­å—ä¸­é—´äººæ”»å‡»
5. è‡ªç­¾åè¯ä¹¦ç”³è¯·ç®€å•ã€å…è´¹ã€æ›´æ–°ç®€ç­”
## what
1. è‡ªç­¾åè¯ä¹¦ç”±ä¼ä¸šè‡ªå·±ç”³è¯·ï¼Œæœªç»è¿‡CAè®¤è¯
2. ç”³è¯·åéœ€è¦ä¿ç•™ç§é’¥å’Œè¯ä¹¦

|        | ç§é’¥ (Private Key)                      | è¯ä¹¦ (Certificate)       |
| :----- | :-------------------------------------- | :----------------------- |
| å†…å®¹   | ä¸€ä¸²è‡ªå·±ä¿ç®¡çš„ç§˜å¯†åŠ å¯†ä¿¡æ¯              | åŒ…å«å…¬é’¥ã€èº«ä»½ä¿¡æ¯ã€ç­¾å |
| ä½œç”¨   | ç”¨æ¥åŠ å¯†/è§£å¯†ï¼Œç­¾åè®¤è¯è‡ªå·±             | æä¾›ç»™å¤–éƒ¨ï¼Œè¯æ˜è‡ªå·±èº«ä»½ |
| è°ä¿å­˜ | åªè‡ªå·±ä¿å­˜ï¼ˆç»ä¸èƒ½æ³„éœ²ï¼‰                | å…¬å¸ƒç»™åˆ«äºº               |
| å…³è”   | è¯ä¹¦é‡Œé¢çš„å…¬é’¥ **å¿…é¡»æ˜¯ç§é’¥å¯¹åº”çš„å…¬é’¥** |                          |

| æ–‡ä»¶åç¼€ | å†…å®¹           | ç”¨é€”                  |
| :------- | :------------- | :-------------------- |
| .key     | ç§é’¥           | nginx / apache ç”¨     |
| .crt     | è‡ªç­¾åè¯ä¹¦     | nginx / apache ç”¨     |
| .pem     | åŒ…å«ç§é’¥å’Œè¯ä¹¦ | æœ‰äº›æ¡†æ¶è¦æ±‚ PEM æ ¼å¼ |
**è¯ä¹¦å·¥ä½œåŸç†**
```scss
(è‡ªå·±ç”Ÿæˆ)
ç§é’¥  ----[ç”Ÿæˆå…¬é’¥]---> è¯ä¹¦
                        (åŒ…å«å…¬é’¥ã€èº«ä»½ã€ç­¾å)

ä½¿ç”¨æ—¶ï¼š
æœåŠ¡å™¨ï¼š
    æ‹¿ç§é’¥ç­¾åã€è§£å¯†
å®¢æˆ·ç«¯ï¼š
    æ‹¿è¯ä¹¦æ ¡éªŒã€åŠ å¯†
```

## how
### è¯ä¹¦ç”³è¯·
1. è‡ªç­¾åè¯ä¹¦ä¾èµ–OpenSSLï¼Œè¿›å…¥[OpenSSL Install](https://slproweb.com/products/Win32OpenSSL.html)ä¸‹è½½ï¼Œé»˜è®¤å®‰è£…å³å¯
2. è¯ä¹¦ç”³è¯·æµç¨‹
    1. åˆ›å»ºç§é’¥
    2. åˆ›å»ºè¯ä¹¦è¯·æ±‚
    3. åˆ›å»ºè¯ä¹¦
    4. ç”Ÿæˆ PEM æ–‡ä»¶ï¼ˆå°†ç§é’¥+è¯ä¹¦åˆå¹¶ï¼‰[å¯é€‰]
3. æ¯æ¬¡ç”Ÿæˆçš„è¯ä¹¦å†…å®¹å‡ä¸åŒ
**è„šæœ¬**
```bash
@echo off

chcp 65001

rem ç”Ÿæˆç§é’¥ï¼Œé•¿åº¦ä¸º4096
openssl genrsa -out server.key 4096

rem ç”ŸæˆCSR (è¯ä¹¦ç­¾åè¯·æ±‚)ï¼Œä½¿ç”¨ç§é’¥å’Œé…ç½®æ–‡ä»¶
rem æ³¨æ„ï¼šåœ¨Windowsä¸Šï¼Œ-dayså‚æ•°çš„å€¼ä¸èƒ½è¶…è¿‡ 36500ï¼ˆ100å¹´ï¼‰ï¼Œå¦åˆ™ä¼šæŠ¥é”™
openssl req -new -key server.key -out server.csr -config csr.conf

rem è‡ªç­¾åç”Ÿæˆè¯ä¹¦ï¼Œæœ‰æ•ˆæœŸ1095å¤©
openssl x509 -req -days 1095 -in server.csr -signkey server.key -out server.crt -extensions req_ext -extfile csr.conf

rem åˆå¹¶æˆä¸€ä¸ªPEMæ–‡ä»¶ï¼ˆåŒæ—¶åŒ…å«ç§é’¥å’Œè¯ä¹¦ï¼‰[å¯é€‰]
copy /b server.key+server.crt server.pem

pause
```

```bash
# csr.conf
[ req ]
default_bits       = 4096
prompt             = no
default_md         = sha256
distinguished_name = dn
req_extensions     = req_ext

[ dn ]
C = CN
ST = Zhejiang
L = Hangzhou
O = server
OU = R&D
CN = server.local

[ req_ext ]
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = server.local
IP.1 = 192.168.1.8
IP.2 = 127.0.0.1
```
CN è®¾ç½®ä¸€å®šè¦åŒDNSä¸€è‡´

| csr.conf key         | è§£é‡Š                                                    |
| :------------------- | :------------------------------------------------------ |
| Country Name         | CN                                                      |
| State or Province    | çœåï¼Œæ¯”å¦‚ Jiangsu                                      |
| Locality             | åŸå¸‚ï¼Œæ¯”å¦‚ Nanjing                                      |
| Organization         | å…¬å¸åï¼Œéšä¾¿å¡«                                          |
| Organizational Unit  | éƒ¨é—¨åï¼Œéšä¾¿å¡«                                          |
| **Common Name (CN)** | âš¡ï¸âš¡ï¸æœåŠ¡å™¨è®¿é—®åœ°å€ï¼Œæ¯”å¦‚ 192.168.1.100 æˆ– my-server.local |

### è¯ä¹¦å¦‚ä½•å·¥ä½œ
1. `subjectAltName`ï¼ˆSANï¼‰ ä¸­çš„ `DNS.x` å’Œ `IP.x` æ˜¯å®¢æˆ·ç«¯ç”¨äº **æ ¡éªŒè¯ä¹¦åˆæ³•æ€§** ï¼Œâ€œå½“å®¢æˆ·ç«¯è®¿é—®çš„ä¸»æœºåï¼ˆæˆ– IPï¼‰ä¸ SAN ä¸­çš„ä»»ä¸€æ¡åŒ¹é…æ—¶ï¼Œè®¤ä¸ºè¯ä¹¦æœ‰æ•ˆâ€
2. åªè¦è®¿é—®çš„æ˜¯ SAN é‡Œå£°æ˜è¿‡çš„ DNS æˆ– IPï¼Œå°±ä¸ä¼šæŠ¥è¯ä¹¦é”™è¯¯ï¼Œ**DNS åæœ€åè§£ææˆä»€ä¹ˆ IPï¼Œè¯ä¹¦ä¸å…³å¿ƒ**

### è¯ä¹¦å®‰è£…
#### æœåŠ¡ç«¯
éœ€è¦æ·»åŠ ç§é’¥å’Œå¯†é’¥è·¯å¾„
**Nginx**
1. æ·»åŠ `HTTPS`é…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤º
```cpp
server {
    listen 443 ssl;
    server_name 192.168.1.10;  # ä½ çš„æœåŠ¡å™¨ IPï¼ˆæˆ–è€…å†…ç½‘åŸŸåï¼‰

    ssl_certificate      /path/to/server.crt;  # è‡ªç­¾è¯ä¹¦è·¯å¾„
    ssl_certificate_key  /path/to/server.key;  # ç§é’¥è·¯å¾„

    ssl_protocols        TLSv1.3;  # å¼ºåˆ¶ä½¿ç”¨ TLS 1.3
    ssl_prefer_server_ciphers on;

    location / {
        root /path/to/your/site;
        index index.html;
    }
}
```

**HttpServer.cpp**
éœ€è¦`.pem`æ ¼å¼è¯ä¹¦ï¼Œå†…å®¹ä¸­åŒ…å«å…¬é’¥è¯ä¹¦å’Œç§é’¥
```cpp
{
  "SslEnabled": true,
  "SslCertificate": "certificate.pem",
  "SslMinimumProtocolVersion": 4,
  "SslVerifyPeers": false,
  "SslTrustedClientCertificates": "trustedClientCertificates.pem"
}
// 1. å¯ç”¨ SSL åŠŸèƒ½ä»¥æ”¯æŒè‡ªç­¾åè¯ä¹¦ã€‚
// 2. è®¾ç½® SSL è¯ä¹¦çš„è·¯å¾„ï¼Œè¯ä¹¦æ–‡ä»¶å¿…é¡»æ˜¯ PEM æ ¼å¼ï¼ŒåŒ…å«è¯ä¹¦å’Œç§é’¥ã€‚
// 3. è®¾ç½®æœ€ä½æ”¯æŒçš„ SSL åè®®ç‰ˆæœ¬ï¼Œå»ºè®®è®¾ç½®ä¸º TLS 1.2ã€‚
// 4. å¯ç”¨å¯¹å®¢æˆ·ç«¯è¯ä¹¦çš„éªŒè¯ä»¥å¢å¼ºå®‰å…¨æ€§ã€‚-> å¯ç”¨åæ£€æµ‹CAè¯ä¹¦æœ‰æ•ˆæ€§
// 5. ç½®å—ä¿¡ä»»çš„å®¢æˆ·ç«¯è¯ä¹¦æ–‡ä»¶è·¯å¾„ï¼Œç”¨äºéªŒè¯å®¢æˆ·ç«¯èº«ä»½ã€‚->CAè¯ä¹¦
```

æ³¨ï¼š**TLS/SSLåŠ å¯†å¥—ä»¶**ï¼ˆå¦‚ `ECDHE-ECDSA-AES256-GCM-SHA384`ï¼‰æ˜¯åœ¨é…ç½®æœåŠ¡å™¨ï¼ˆå¦‚ Nginxã€Apacheï¼‰æ—¶æŒ‡å®šçš„ï¼Œè€Œä¸æ˜¯ç”Ÿæˆå¯†é’¥æ—¶é€‰æ‹©çš„ã€‚
#### å®¢æˆ·ç«¯
ä»…å®‰è£…è¯ä¹¦å³å¯
1. åŒå‡»`.crt`æ–‡ä»¶->å®‰è£…è¯ä¹¦
2. é€‰æ‹©â€œæœ¬åœ°è®¡ç®—æœºå®‰è£…â€
3. æ‰‹åŠ¨é€‰æ‹©è¯ä¹¦å­˜å‚¨ä½ç½®ï¼Œå°†è¯ä¹¦å®‰è£…è‡³"å—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„"

## å‚è€ƒæ–‡ç« 
[ä»€ä¹ˆæ˜¯è‡ªç­¾åè¯ä¹¦åŠå…¶å·¥ä½œåŸç†ï¼Ÿ](https://www.ssldragon.com/zh/blog/what-is-self-signed-certificate/)
[å¦‚ä½•åˆ¶ä½œå’Œä½¿ç”¨è‡ªç­¾åè¯ä¹¦ - è‹æ´‹åšå®¢](https://soulteary.com/2021/02/06/how-to-make-and-use-a-self-signed-certificate.html)
